generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Usuario {
  id             BigInt        @id @default(autoincrement())
  email          String        @unique
  nombreCompleto String
  telefono       String?
  estado         EstadoUsuario @default(ACTIVO)
  rol            Rol
  authId         String?       @unique @map("auth_id") @db.Uuid
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  ultimoAcceso   DateTime?     @map("ultimo_acceso")
  createdBy      String?       @map("created_by") @db.Uuid

  pedidosCreador      Pedido[]     @relation("PedidoCreator")
  despachos           Despacho[]
  cotizacionesCreadas Cotizacion[] @relation("CotizacionCreador")

  @@map("usuarios")
}

model Cliente {
  id          BigInt   @id @default(autoincrement())
  ruc         Decimal? @db.Decimal(11, 0)
  razonSocial String?  @map("razon_social")
  email       String   @unique
  telefono    BigInt?
  direccion   String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  authId      String?  @unique @map("auth_id") @db.Uuid
  createdBy   String?  @map("created_by") @db.Uuid

  pedidos      Pedido[]
  cotizaciones Cotizacion[]

  @@map("clientes")
}

model Producto {
  id          BigInt         @id @default(autoincrement())
  nombre      String         @db.VarChar(255)
  descripcion String?        @db.Text
  precio      Decimal        @db.Decimal(10, 2)
  categoriaId BigInt         @map("categoria_id")
  stock       Int            @default(0)
  stockMinimo Int            @default(10) @map("stock_minimo")
  imagen      String?        @db.VarChar(500)
  estado      EstadoProducto @default(activo)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  categoria      Categoria          @relation(fields: [categoriaId], references: [id])
  variantes      VarianteProducto[]
  detallesPedido DetallePedido[]

  @@map("productos")
}

model Categoria {
  id          BigInt   @id @default(autoincrement())
  nombre      String   @unique @db.VarChar(100)
  descripcion String?  @db.Text
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  productos Producto[]

  @@map("categorias")
}

model VarianteProducto {
  id              BigInt   @id @default(autoincrement())
  productoId      BigInt   @map("producto_id")
  nombre          String
  valor           String
  stockAdicional  Int      @default(0) @map("stock_adicional")
  precioAdicional Float    @default(0) @map("precio_adicional")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  producto        Producto         @relation(fields: [productoId], references: [id], onDelete: Cascade)
  itemsCotizacion ItemCotizacion[]

  @@map("variantes_producto")
}

model Pedido {
  id           BigInt          @id @default(autoincrement())
  clienteId    BigInt          @map("cliente_id")
  estado       EstadoPedido    @default(PENDIENTE)
  prioridad    PrioridadPedido @default(NORMAL)
  fechaPedido  DateTime        @default(now()) @map("fecha_pedido")
  fechaEntrega DateTime?       @map("fecha_entrega")
  total        Float
  created_by   String?         @map("created_by") @db.Uuid
  updated_by   String?         @map("updated_by") @db.Uuid
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  detalles     DetallePedido[]
  confecciones Confeccion[]
  despachos    Despacho[]
  cliente      Cliente         @relation(fields: [clienteId], references: [id])
  creador      Usuario?        @relation("PedidoCreator", fields: [created_by], references: [authId])

  @@map("pedidos")
}

model DetallePedido {
  id             BigInt   @id @default(autoincrement())
  pedidoId       BigInt   @map("pedido_id")
  productoId     BigInt   @map("producto_id")
  cantidad       Int
  precioUnitario Float    @map("precio_unitario")
  subtotal       Float
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  pedido   Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  producto Producto @relation(fields: [productoId], references: [id])

  @@map("detalles_pedido")
}

model Inventario {
  id           BigInt   @id @default(autoincrement())
  nombre       String
  tipo         String
  unidadMedida String   @map("unidad_medida")
  stockActual  Int      @map("stock_actual")
  stockMinimo  Int      @map("stock_minimo")
  activo       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("inventario")
}

model Confeccion {
  id            BigInt           @id @default(autoincrement())
  pedidoId      BigInt           @map("pedido_id")
  tallerId      BigInt           @map("taller_id")
  estado        EstadoConfeccion @default(PENDIENTE)
  fechaInicio   DateTime         @map("fecha_inicio")
  fechaFin      DateTime?        @map("fecha_fin")
  observaciones String?
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  pedido Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  taller Taller @relation(fields: [tallerId], references: [id])

  @@map("confecciones")
}

model Despacho {
  id               BigInt         @id @default(autoincrement())
  pedidoId         BigInt         @map("pedido_id")
  usuarioId        BigInt         @map("usuario_id")
  estado           EstadoDespacho @default(PENDIENTE)
  fechaDespacho    DateTime       @map("fecha_despacho")
  fechaEntrega     DateTime?      @map("fecha_entrega")
  direccionEntrega String         @map("direccion_entrega")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  pedido  Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@map("despachos")
}

model Taller {
  id        BigInt   @id @default(autoincrement())
  nombre    String
  direccion String
  telefono  String
  email     String?  @unique
  estado    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  confecciones Confeccion[]

  @@map("talleres")
}

model Cotizacion {
  id           BigInt           @id @default(autoincrement())
  clienteId    BigInt           @map("cliente_id")
  usuarioId    BigInt           @map("usuario_id")
  estado       EstadoCotizacion @default(PENDIENTE)
  total        Float
  fechaCotizac DateTime         @default(now()) @map("fecha_cotizac")
  creadoPor    String?          @map("creado_por")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  cliente Cliente          @relation(fields: [clienteId], references: [id])
  usuario Usuario          @relation("CotizacionCreador", fields: [usuarioId], references: [id])
  items   ItemCotizacion[]

  @@map("cotizaciones")
}

model ItemCotizacion {
  id             BigInt   @id @default(autoincrement())
  cotizacionId   BigInt   @map("cotizacion_id")
  varianteId     BigInt   @map("variante_id")
  cantidad       Int
  precioUnitario Float    @map("precio_unitario")
  subtotal       Float
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  cotizacion Cotizacion       @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  variante   VarianteProducto @relation(fields: [varianteId], references: [id])

  @@map("items_cotizacion")
}

enum EstadoCotizacion {
  PENDIENTE
  APROBADA
  RECHAZADA
  CERRADA
}

enum Rol {
  administrador
  cortador
  dise√±ador
  recepcionista
  ayudante
  representante_taller
}

enum EstadoPedido {
  PENDIENTE
  EN_PROCESO
  TERMINADO
  ENTREGADO
  CANCELADO
}

enum EstadoConfeccion {
  PENDIENTE
  EN_PROCESO
  TERMINADO
}

enum EstadoDespacho {
  PENDIENTE
  EN_RUTA
  ENTREGADO
}

enum EstadoUsuario {
  ACTIVO
  INACTIVO
  SUSPENDIDO
}

enum PrioridadPedido {
  BAJA
  NORMAL
  ALTA
  URGENTE
}

enum EstadoProducto {
  activo
  inactivo
  agotado
  descontinuado

  @@map("estado_producto")
}
